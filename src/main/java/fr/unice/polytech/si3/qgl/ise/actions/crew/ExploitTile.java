package fr.unice.polytech.si3.qgl.ise.actions.crew;

import fr.unice.polytech.si3.qgl.ise.actions.CrewAction;
import fr.unice.polytech.si3.qgl.ise.actions.StopAction;
import fr.unice.polytech.si3.qgl.ise.entities.Crew;
import fr.unice.polytech.si3.qgl.ise.enums.Abundance;
import fr.unice.polytech.si3.qgl.ise.enums.RawResource;
import fr.unice.polytech.si3.qgl.ise.map.Coordinates;
import fr.unice.polytech.si3.qgl.ise.map.PathFinder;

public class ExploitTile extends CrewAction
{
    private RawResource resource;
    private Step        currentStep;
    private Exploit     exploit;
    private Explore     explore;
    private Move_to     move_to;
    private StopAction  stopAction;
    private CrewAction  toAcknowledge;
    private boolean reExplore = false;

    public ExploitTile (Crew crewToUpdate, RawResource resource)
    {
        super(crewToUpdate);
        this.resource = resource;
        currentStep = Step.Explore;
        exploit = new Exploit(crewToUpdate, resource);
        explore = new Explore(crewToUpdate);
        stopAction = new StopAction();
    }

    public String apply ()
    {
        String res;
        Step nextStep;

        switch (currentStep)
        {
            case Explore:
                res = explore.apply();

                toAcknowledge = explore;
                explore.reset();
                nextStep = Step.Exploit;
                break;

            case Exploit:
                if (!foundResource())
                {
                    currentStep = Step.FindAnotherTile;
                    move_to.reset();
                    return apply();
                }

                if (keepExploiting())
                {
                    res = exploit.apply();
                    toAcknowledge = exploit;
                }
                else
                {
                    this.finish();
                    res = stopAction.apply();
                    toAcknowledge = null;
                }

                nextStep = Step.Explore;
                reExplore = true;
                exploit.reset();
                break;

            case FindAnotherTile:
                if (move_to == null) move_to = new Move_to(getCrewToUpdate(), findAnotherTile());
                if (!move_to.isFinished())
                {
                    res = move_to.apply();
                    toAcknowledge = move_to;
                    nextStep = Step.FindAnotherTile;

                    if (res.isEmpty())
                    {
                        nextStep = Step.Explore;
                        res = apply();
                    }
                }
                else
                {
                    nextStep = Step.Explore;
                    res = apply();
                }
                break;

            default:
                throw new IllegalStateException("Unknown step : " + currentStep);
        }
        currentStep = nextStep;

        return res;
    }

    private boolean foundResource ()
    {
        Crew crew = getCrewToUpdate();
        return crew.getLastExplore().containsKey(resource);
    }

    private boolean keepExploiting ()
    {
        Crew crew = getCrewToUpdate();
        return (crew.getLastExplore().get(resource) != Abundance.LOW);
    }

    private Coordinates findAnotherTile ()
    {
        Crew crew = getCrewToUpdate();
        crew.getMap().getTile(crew.getCoords()).setExplored(true);
        return PathFinder.findNearestTileOfResource(crew.getMap(), crew.getCoords(), resource);
    }

    public String acknowledgeResults (Crew crewToUpdate, String result)
    {
        return toAcknowledge == null ? "" : toAcknowledge.acknowledgeResults(crewToUpdate, result);
    }

    public enum Step
    {
        Exploit,
        FindAnotherTile,
        Explore
    }
}
